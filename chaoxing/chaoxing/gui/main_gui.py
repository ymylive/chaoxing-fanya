#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Chaoxing GUI Main Window - ‰øÆÂ§çÁâàÊú¨

ËøôÊòØ‰øÆÂ§ç‰∫ÜËÆ∞‰ΩèÁôªÂΩïÂäüËÉΩÁöÑÂÆåÊï¥GUIÊñá‰ª∂
"""

import sys
import os
from pathlib import Path
from typing import Dict, List, Optional, Union
from PySide6.QtWidgets import (
    QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout, 
    QLineEdit, QPushButton, QListWidget, QListWidgetItem, QLabel,
    QComboBox, QDoubleSpinBox, QSpinBox, QCheckBox, QTextEdit,
    QMessageBox, QMenuBar, QFileDialog, QSplitter,
    QGraphicsOpacityEffect, QProgressBar
)
from PySide6.QtCore import (
    Qt, QThread, Signal, QPropertyAnimation, QEasingCurve, 
    QRect, QTimer, QObject, QSize
)
from PySide6.QtGui import QFont, QPalette, QColor, QIcon

# ÂÖ®Â±ÄÊó•Âøó
app_file_logger = None
try:
    from api.logger import logger as app_file_logger
except Exception:
    pass

class AnimatedButton(QPushButton):
    def __init__(self, text: str, parent=None):
        super().__init__(text, parent)
        self._animation = None

class AnimatedListItem(QListWidgetItem):
    def __init__(self, text: str, parent=None):
        super().__init__(text, parent)
        self._opacity_effect = None

class MainWindow(QMainWindow):
    def __init__(self) -> None:
        super().__init__()
        self.setWindowTitle("Chaoxing Â≠¶‰π†Âä©Êâã (GUI)")
        self.setMinimumSize(QSize(1100, 700))

        self._build_menu()
        self._build_ui()
        self._install_log_sink()

        # runtime state
        self._all_courses = []
        self._login_worker = None
        self._run_worker = None
        
        # Âä†ËΩΩ‰øùÂ≠òÁöÑÁôªÂΩï‰ø°ÊÅØ
        self._load_saved_credentials()

    def _build_tiku_conf(self) -> dict:
        # ËßÑËåÉÂåñÊù•Ëá™UIÁöÑÈ¢òÂ∫ìÈÖçÁΩÆÔºåÊò†Â∞Ñ‰∏∫ÂêéÁ´ØÊâÄÈúÄÊ†ºÂºè
        provider_label = self.tiku_provider.currentText().strip()
        provider_mapping = {
            "üè™ Êó†": "",
            "üè™ TikuYanxi": "TikuYanxi",
            "üè™ TikuLike": "TikuLike",
            "üè™ TikuAdapter": "TikuAdapter",
            "üè™ AI": "AI",
            "üè™ SiliconFlow": "SiliconFlow",
        }
        provider = provider_mapping.get(provider_label, "")

        submit_label = self.tiku_submit.currentText().strip()
        submit_mapping = {
            "üì§ Âè™‰øùÂ≠ò": "false",
            "üì§ Êèê‰∫§": "true",
        }
        submit_value = submit_mapping.get(submit_label, "false")

        # Ensure required keys for Tiku.init_tiku
        tiku_conf = {
            "provider": provider,
            "submit": submit_value,
            "cover_rate": str(self.tiku_cover.value()),
            "delay": str(self.tiku_delay.value()),
            "tokens": self.tiku_tokens.text().strip(),
            # defaults aligned with config_template.ini
            "true_list": "Ê≠£Á°Æ,ÂØπ,‚àö,ÊòØ",
            "false_list": "ÈîôËØØ,Èîô,√ó,Âê¶,‰∏çÂØπ,‰∏çÊ≠£Á°Æ",
            # ‰º†ÈÄí‰ª£ÁêÜÁªôÂèØËÉΩÁî®Âà∞ÁöÑÈ¢òÂ∫ìÔºàÂ¶ÇAIÔºâ
            "http_proxy": self.proxy_edit.text().strip() or "",
        }
        return tiku_conf

    def _build_menu(self) -> None:
        menubar = self.menuBar()
        
        # File menu
        file_menu = menubar.addMenu("Êñá‰ª∂(&F)")
        
        load_config_action = file_menu.addAction("üìÇ Âä†ËΩΩÈÖçÁΩÆÊñá‰ª∂...")
        load_config_action.triggered.connect(self._load_config_dialog)
        
        file_menu.addSeparator()
        
        exit_action = file_menu.addAction("‚ùå ÈÄÄÂá∫")
        exit_action.triggered.connect(self.close)

    def _build_ui(self) -> None:
        container = QWidget()
        self.setCentralWidget(container)
        
        # ‰∏ªÂ∏ÉÂ±Ä - Ê∞¥Âπ≥ÂàÜÂâ≤
        main_layout = QHBoxLayout(container)
        splitter = QSplitter(Qt.Horizontal)
        main_layout.addWidget(splitter)

        # Â∑¶‰æßÊéßÂà∂Èù¢Êùø
        left_panel = QWidget()
        left_layout = QVBoxLayout(left_panel)
        left_layout.setContentsMargins(8, 8, 8, 8)
        left_layout.setSpacing(4)

        # Ë¥¶Âè∑ÁôªÂΩïÂå∫Âüü
        self.username_edit = QLineEdit()
        self.username_edit.setPlaceholderText("üì± ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑Á†Å")
        self.password_edit = QLineEdit()
        self.password_edit.setEchoMode(QLineEdit.Password)
        self.password_edit.setPlaceholderText("üîê ËØ∑ËæìÂÖ•ÁôªÂΩïÂØÜÁ†Å")
        
        # ËÆ∞‰ΩèÊàëÈÄâÈ°π
        self.remember_checkbox = QCheckBox("ËÆ∞‰ΩèÁôªÂΩï‰ø°ÊÅØ")
        self.remember_checkbox.setStyleSheet("margin-top: 2px; margin-bottom: 2px;")
        self.remember_checkbox.stateChanged.connect(self._on_remember_changed)
        
        self.login_btn = AnimatedButton("üöÄ ÁôªÂΩïÂπ∂Ëé∑ÂèñËØæÁ®ã")
        self.login_btn.setMinimumHeight(24)
        self.login_btn.clicked.connect(self._on_login_clicked)
        
        # Ê∑ªÂä†Âà∞‰∏ªÂ∏ÉÂ±Ä
        left_layout.addWidget(self.username_edit)
        left_layout.addWidget(self.password_edit)
        left_layout.addWidget(self.remember_checkbox)
        left_layout.addWidget(self.login_btn)
        left_layout.addSpacing(6)

        # ËøêË°åËÆæÁΩÆÂå∫Âüü
        self.speed_spin = QDoubleSpinBox()
        self.speed_spin.setRange(1.0, 2.0)
        self.speed_spin.setSingleStep(0.1)
        self.speed_spin.setValue(1.0)
        self.speed_spin.setPrefix("‚ö° ")
        self.speed_spin.setSuffix("x")
        
        self.notopen_combo = QComboBox()
        self.notopen_combo.addItems(["üîÅ ÈáçËØï", "‚ùì ËØ¢ÈóÆ", "‚û°Ô∏è ÁªßÁª≠"])
        
        # Ê∑ªÂä†Âà∞‰∏ªÂ∏ÉÂ±Ä
        left_layout.addWidget(self.speed_spin)
        left_layout.addWidget(self.notopen_combo)
        left_layout.addSpacing(6)

        # È¢òÂ∫ìËÆæÁΩÆÂå∫Âüü
        self.tiku_provider = QComboBox()
        self.tiku_provider.addItems(["üè™ Êó†", "üè™ TikuYanxi", "üè™ TikuLike", "üè™ TikuAdapter", "üè™ AI", "üè™ SiliconFlow"])
        
        self.tiku_submit = QComboBox()
        self.tiku_submit.addItems(["üì§ Âè™‰øùÂ≠ò", "üì§ Êèê‰∫§"])
        
        self.tiku_cover = QDoubleSpinBox()
        self.tiku_cover.setRange(0.0, 1.0)
        self.tiku_cover.setSingleStep(0.05)
        self.tiku_cover.setValue(0.9)
        self.tiku_cover.setPrefix("üìä ")
        
        self.tiku_delay = QDoubleSpinBox()
        self.tiku_delay.setRange(0.5, 10.0)
        self.tiku_delay.setSingleStep(0.5)
        self.tiku_delay.setValue(1.0)
        self.tiku_delay.setPrefix("‚è±Ô∏è ")
        self.tiku_delay.setSuffix("s")
        
        self.tiku_tokens = QLineEdit()
        self.tiku_tokens.setPlaceholderText("üîë APIÂØÜÈí• (ÂèØÈÄâ)")
        
        # Ê∑ªÂä†Âà∞‰∏ªÂ∏ÉÂ±Ä
        left_layout.addWidget(self.tiku_provider)
        left_layout.addWidget(self.tiku_submit)
        left_layout.addWidget(self.tiku_cover)
        left_layout.addWidget(self.tiku_delay)
        left_layout.addWidget(self.tiku_tokens)
        left_layout.addSpacing(6)

        # ‰ª£ÁêÜËÆæÁΩÆ
        self.proxy_edit = QLineEdit()
        self.proxy_edit.setPlaceholderText("üåê HTTP‰ª£ÁêÜ (ÂèØÈÄâ)")
        left_layout.addWidget(self.proxy_edit)
        left_layout.addSpacing(6)

        # ÊéßÂà∂ÊåâÈíÆ
        self.start_btn = AnimatedButton("üéØ ÂºÄÂßãÂ≠¶‰π†")
        self.start_btn.clicked.connect(self._start_run)
        self.start_btn.setEnabled(False)
        
        self.stop_btn = QPushButton("‚èπÔ∏è ÂÅúÊ≠¢")
        self.stop_btn.clicked.connect(self._stop_run)
        self.stop_btn.setEnabled(False)
        
        left_layout.addWidget(self.start_btn)
        left_layout.addWidget(self.stop_btn)
        left_layout.addStretch()

        # Âè≥‰æßÈù¢Êùø
        right_panel = QWidget()
        right_layout = QVBoxLayout(right_panel)
        
        # ËØæÁ®ãÂàóË°®
        self.course_status = QLabel("üîç ËØ∑ÂÖàÁôªÂΩïËé∑ÂèñËØæÁ®ãÂàóË°®")
        self.course_status.setStyleSheet("font-weight: 500; color: #6b7280;")
        right_layout.addWidget(self.course_status)
        
        self.course_list = QListWidget()
        self.course_list.setMinimumHeight(200)
        right_layout.addWidget(self.course_list)
        
        # Êó•ÂøóËæìÂá∫
        log_label = QLabel("üìã ËøêË°åÊó•Âøó")
        log_label.setStyleSheet("font-weight: 500; margin-top: 8px;")
        right_layout.addWidget(log_label)
        
        self.log_output = QTextEdit()
        self.log_output.setMaximumHeight(200)
        self.log_output.setReadOnly(True)
        right_layout.addWidget(self.log_output)

        # Ê∑ªÂä†Èù¢ÊùøÂà∞ÂàÜÂâ≤Âô®
        splitter.addWidget(left_panel)
        splitter.addWidget(right_panel)
        splitter.setSizes([300, 800])

    def _install_log_sink(self) -> None:
        """ÂÆâË£ÖÊó•ÂøóÊé•Êî∂Âô®"""
        try:
            log_bus = LogBus.instance()
            log_bus.message_received.connect(self._append_log)
        except Exception:
            pass

    def _append_log(self, message: str) -> None:
        """Ê∑ªÂä†Êó•ÂøóÊ∂àÊÅØ"""
        try:
            self.log_output.append(message)
            # Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
            scrollbar = self.log_output.verticalScrollBar()
            scrollbar.setValue(scrollbar.maximum())
        except Exception:
            pass

    # ===== ÈÖçÁΩÆÁõ∏ÂÖ≥ =====
    
    def _load_config_dialog(self) -> None:
        file_path, _ = QFileDialog.getOpenFileName(
            self, "ÈÄâÊã©ÈÖçÁΩÆÊñá‰ª∂", "", "INI files (*.ini);;All files (*)"
        )
        if file_path:
            self._load_config(Path(file_path))

    def _load_config(self, path: Path) -> None:
        try:
            import configparser
            cfg = configparser.ConfigParser()
            cfg.read(path, encoding='utf-8')
            
            # Âä†ËΩΩÈÖçÁΩÆÂà∞UI
            if cfg.has_section("common"):
                self.speed_spin.setValue(cfg.getfloat("common", "speed", fallback=1.0))
                self.proxy_edit.setText(cfg.get("common", "http_proxy", fallback=""))
                
            if cfg.has_section("tiku"):
                provider = cfg.get("tiku", "provider", fallback="")
                for i in range(self.tiku_provider.count()):
                    if provider in self.tiku_provider.itemText(i):
                        self.tiku_provider.setCurrentIndex(i)
                        break
                        
                submit = cfg.get("tiku", "submit", fallback="false")
                if submit.lower() == "true":
                    self.tiku_submit.setCurrentIndex(1)
                else:
                    self.tiku_submit.setCurrentIndex(0)
                    
                self.tiku_cover.setValue(cfg.getfloat("tiku", "cover_rate", fallback=0.9))
                self.tiku_delay.setValue(cfg.getfloat("tiku", "delay", fallback=1.0))
                self.tiku_tokens.setText(cfg.get("tiku", "tokens", fallback=""))
        except Exception as e:
            QMessageBox.critical(self, "ËØªÂèñÂ§±Ë¥•", str(e))

    # ===== ÁôªÂΩïÁõ∏ÂÖ≥ =====
    
    def _on_login_clicked(self) -> None:
        # Run real login + fetch courses in background
        username = self.username_edit.text().strip()
        password = self.password_edit.text().strip()
        if not username or not password:
            QMessageBox.warning(self, "ÊèêÁ§∫", "ËØ∑ÂÖàÂ°´ÂÜôÊâãÊú∫Âè∑ÂíåÂØÜÁ†Å")
            return
            
        # Â¶ÇÊûúÂãæÈÄâ‰∫ÜËÆ∞‰ΩèÁôªÂΩï‰ø°ÊÅØÔºå‰øùÂ≠òÂá≠ÊçÆ
        if self.remember_checkbox.isChecked():
            self._save_credentials(username, password)
            
        if app_file_logger:
            try:
                masked = f"{username[:3]}****{username[-2:]}" if len(username) >= 5 else "***"
                app_file_logger.info(f"GUI: ÁôªÂΩïÊåâÈíÆÁÇπÂáª, user={masked}, proxy={(self.proxy_edit.text().strip() or 'none')}")
            except Exception:
                pass
        self.login_btn.setEnabled(False)
        self._append_log("ÂáÜÂ§áÁôªÂΩï...")
        self._set_busy(True)
        # Build minimal tiku config from UI (optional)
        tiku_conf = self._build_tiku_conf()
        self._login_worker = LoginWorker(username, password, tiku_conf)
        # propagate optional proxy string
        self._login_worker.http_proxy = self.proxy_edit.text().strip() or None
        self._login_worker.success.connect(self._on_login_success)
        self._login_worker.error.connect(self._on_login_failed)
        self._login_worker.finished.connect(lambda: (self.login_btn.setEnabled(True), self._set_busy(False)))
        self._login_worker.start()

    def _set_busy(self, busy: bool) -> None:
        """ËÆæÁΩÆÂøôÁ¢åÁä∂ÊÄÅ"""
        # ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂøôÁ¢åÊåáÁ§∫Âô®
        pass

    # ===== ËøêË°åÁõ∏ÂÖ≥ =====
    
    def _start_run(self) -> None:
        # Start main workflow in background using existing logic
        username = self.username_edit.text().strip()
        password = self.password_edit.text().strip()
        if not username or not password:
            QMessageBox.warning(self, "ÊèêÁ§∫", "ËØ∑ÂÖàÁôªÂΩïÊàñÂ°´ÂÜôË¥¶Âè∑ÂØÜÁ†Å")
            return
        if not self._all_courses:
            QMessageBox.warning(self, "ÊèêÁ§∫", "ËØ∑ÂÖàËé∑ÂèñËØæÁ®ãÂàóË°®")
            return
        # Build selected courses payload (full dicts)
        selected = []
        for i in range(self.course_list.count()):
            item = self.course_list.item(i)
            if item.checkState() == Qt.Checked:
                data = item.data(Qt.UserRole)
                if isinstance(data, dict):
                    selected.append(data)
        if not selected:
            QMessageBox.information(self, "ÊèêÁ§∫", "ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ËØæÁ®ã")
            return
        self.start_btn.setEnabled(False)
        self.start_btn.setText("üîÑ Â≠¶‰π†‰∏≠...")
        self.stop_btn.setEnabled(True)
        self._append_log("üöÄ ÂºÄÂßãÊâßË°åÂ≠¶‰π†ÊµÅÁ®ã...")
        self._set_busy(True)
        tiku_conf = self._build_tiku_conf()
        self._run_worker = RunWorker(
            username=username,
            password=password,
            courses=selected,
            speed=float(self.speed_spin.value()),
            notopen_action=self.notopen_combo.currentText().strip(),
            tiku_conf=tiku_conf,
        )
        # propagate optional proxy to background worker as wellÔºàÂ§áÁî®ÔºõRunWorker ÂÜÖÈÉ®Êú™‰ΩøÁî®ÂàôÂøΩÁï•Ôºâ
        self._run_worker.http_proxy = self.proxy_edit.text().strip() or None
        self._run_worker.finished_ok.connect(self._on_run_finished)
        self._run_worker.error.connect(self._on_run_failed)
        self._run_worker.finished.connect(lambda: (self.start_btn.setEnabled(True), self._set_busy(False)))
        self._run_worker.start()

    def _stop_run(self) -> None:
        # Best-effort stop between courses
        if self._run_worker:
            self._run_worker.request_stop()
            self._append_log("üõë Ê≠£Âú®ÂÅúÊ≠¢Â≠¶‰π†ÊµÅÁ®ã...")

    # ===== ÂõûË∞ÉÂáΩÊï∞ =====
    
    def _on_login_success(self, courses: list) -> None:
        self._append_log("üéâ ÁôªÂΩïÊàêÂäüÔºåÂ∑≤Ëé∑ÂèñËØæÁ®ãÂàóË°®")
        self._all_courses = courses or []
        self.course_list.clear()
        
        if not self._all_courses:
            self.course_status.setText("‚ö†Ô∏è Êú™ÊâæÂà∞ÂèØÁî®ËØæÁ®ã")
            self.course_status.setStyleSheet("font-weight: 500; color: #f59e0b;")
            return
            
        # Êõ¥Êñ∞Áä∂ÊÄÅ
        self.course_status.setText(f"‚úÖ Â∑≤Âä†ËΩΩ {len(self._all_courses)} Èó®ËØæÁ®ã")
        self.course_status.setStyleSheet("font-weight: 500; color: #10b981;")
        
        # Ê∑ªÂä†ËØæÁ®ãÈ°πÁõÆ
        for i, course in enumerate(self._all_courses):
            title = course.get("title", "Êú™ÂëΩÂêçËØæÁ®ã")
            cid = course.get("courseId", "-")
            item = AnimatedListItem(f"üìñ {title} (ID: {cid})")
            item.setData(Qt.UserRole, course)
            item.setCheckState(Qt.Checked)
            self.course_list.addItem(item)
            
        self.start_btn.setEnabled(True)

    def _on_login_failed(self, msg: str) -> None:
        QMessageBox.critical(self, "ÁôªÂΩïÂ§±Ë¥•", msg)
        self._append_log(f"ÁôªÂΩïÂ§±Ë¥•: {msg}")

    def _on_run_finished(self) -> None:
        self.stop_btn.setEnabled(False)
        self.start_btn.setText("üéØ ÂºÄÂßãÂ≠¶‰π†")
        QMessageBox.information(self, "üéâ ‰ªªÂä°ÂÆåÊàê", "ÊâÄÊúâËØæÁ®ãÂ≠¶‰π†‰ªªÂä°Â∑≤ÂÆåÊàêÔºÅ")
        self._append_log("üèÜ ÊâÄÊúâËØæÁ®ãÂ≠¶‰π†‰ªªÂä°Â∑≤ÂÆåÊàê")

    def _on_run_failed(self, msg: str) -> None:
        self.stop_btn.setEnabled(False)
        self.start_btn.setText("üéØ ÂºÄÂßãÂ≠¶‰π†")
        QMessageBox.critical(self, "ÊâßË°åÂ§±Ë¥•", msg)
        self._append_log(f"ÊâßË°åÂ§±Ë¥•: {msg}")

    # ===== ÁôªÂΩïËÆ∞‰ΩèÂäüËÉΩ =====
    
    def _get_config_dir(self) -> Path:
        """Ëé∑ÂèñÈÖçÁΩÆÁõÆÂΩï"""
        import os
        config_dir = Path(os.path.expanduser("~")) / ".chaoxing_gui"
        config_dir.mkdir(exist_ok=True)
        return config_dir
    
    def _get_credentials_file(self) -> Path:
        """Ëé∑ÂèñÂá≠ÊçÆÊñá‰ª∂Ë∑ØÂæÑ"""
        return self._get_config_dir() / "credentials.json"
    
    def _save_credentials(self, username: str, password: str) -> None:
        """‰øùÂ≠òÁôªÂΩïÂá≠ÊçÆ"""
        try:
            import json
            import base64
            
            # ÁÆÄÂçïÂä†ÂØÜÔºàbase64ÁºñÁ†ÅÔºâ
            encoded_password = base64.b64encode(password.encode()).decode()
            
            credentials = {
                "username": username,
                "password": encoded_password,
                "remember": True
            }
            
            with open(self._get_credentials_file(), 'w', encoding='utf-8') as f:
                json.dump(credentials, f, indent=2)
                
            if app_file_logger:
                try:
                    masked = f"{username[:3]}****{username[-2:]}" if len(username) >= 5 else "***"
                    app_file_logger.info(f"GUI: Â∑≤‰øùÂ≠òÁôªÂΩïÂá≠ÊçÆ user={masked}")
                except Exception:
                    pass
                    
        except Exception as e:
            if app_file_logger:
                try:
                    app_file_logger.warning(f"GUI: ‰øùÂ≠òÂá≠ÊçÆÂ§±Ë¥•: {e}")
                except Exception:
                    pass
    
    def _load_saved_credentials(self) -> None:
        """Âä†ËΩΩ‰øùÂ≠òÁöÑÁôªÂΩïÂá≠ÊçÆ"""
        try:
            import json
            import base64
            
            credentials_file = self._get_credentials_file()
            if not credentials_file.exists():
                return
                
            with open(credentials_file, 'r', encoding='utf-8') as f:
                credentials = json.load(f)
                
            if not credentials.get('remember', False):
                return
                
            username = credentials.get('username', '')
            encoded_password = credentials.get('password', '')
            
            if username and encoded_password:
                # Ëß£Á†ÅÂØÜÁ†Å
                try:
                    password = base64.b64decode(encoded_password).decode()
                    
                    # Â°´ÂÖÖÂà∞UI
                    self.username_edit.setText(username)
                    self.password_edit.setText(password)
                    self.remember_checkbox.setChecked(True)
                    
                    if app_file_logger:
                        try:
                            masked = f"{username[:3]}****{username[-2:]}" if len(username) >= 5 else "***"
                            app_file_logger.info(f"GUI: Â∑≤Âä†ËΩΩ‰øùÂ≠òÁöÑÁôªÂΩïÂá≠ÊçÆ user={masked}")
                        except Exception:
                            pass
                            
                except Exception as e:
                    if app_file_logger:
                        try:
                            app_file_logger.warning(f"GUI: Ëß£Á†Å‰øùÂ≠òÁöÑÂØÜÁ†ÅÂ§±Ë¥•: {e}")
                        except Exception:
                            pass
                    
        except Exception as e:
            if app_file_logger:
                try:
                    app_file_logger.warning(f"GUI: Âä†ËΩΩ‰øùÂ≠òÁöÑÂá≠ÊçÆÂ§±Ë¥•: {e}")
                except Exception:
                    pass
    
    def _on_remember_changed(self, state: int) -> None:
        """ËÆ∞‰ΩèÁôªÂΩï‰ø°ÊÅØÁä∂ÊÄÅÊîπÂèò"""
        try:
            if state == 0:  # ÂèñÊ∂àÂãæÈÄâ
                # Âà†Èô§‰øùÂ≠òÁöÑÂá≠ÊçÆ
                credentials_file = self._get_credentials_file()
                if credentials_file.exists():
                    credentials_file.unlink()
                    
                if app_file_logger:
                    try:
                        app_file_logger.info("GUI: Â∑≤Âà†Èô§‰øùÂ≠òÁöÑÁôªÂΩïÂá≠ÊçÆ")
                    except Exception:
                        pass
            else:  # ÂãæÈÄâ
                # Â¶ÇÊûúÂΩìÂâçÊúâËæìÂÖ•ÂÜÖÂÆπÔºåÁ´ãÂç≥‰øùÂ≠ò
                username = self.username_edit.text().strip()
                password = self.password_edit.text().strip()
                if username and password:
                    self._save_credentials(username, password)
                    
        except Exception as e:
            if app_file_logger:
                try:
                    app_file_logger.warning(f"GUI: Â§ÑÁêÜËÆ∞‰ΩèÁä∂ÊÄÅÊîπÂèòÂ§±Ë¥•: {e}")
                except Exception:
                    pass


# ===== ËæÖÂä©Á±ª =====

class LogBus(QObject):
    message_received = Signal(str)
    
    _instance = None
    
    @classmethod
    def instance(cls):
        if cls._instance is None:
            cls._instance = cls()
        return cls._instance


class LoginWorker(QThread):
    success = Signal(list)
    error = Signal(str)

    def __init__(self, username: str, password: str, tiku_conf: dict | None = None) -> None:
        super().__init__()
        self.username = username
        self.password = password
        self.tiku_conf = tiku_conf or {}

    def run(self) -> None:
        try:
            if app_file_logger:
                try:
                    app_file_logger.trace("LoginWorker: start")
                except Exception:
                    pass
            from api.base import Chaoxing, Account
            from api.answer import Tiku
            # init tiku
            tiku = Tiku()
            try:
                if self.tiku_conf:
                    tiku.config_set(self.tiku_conf)
                tiku = tiku.get_tiku_from_config()
                tiku.init_tiku()
            except Exception as te:
                # ÂÆπÈîôÔºöÈ¢òÂ∫ìÈÖçÁΩÆÂºÇÂ∏∏ÂàôÁ¶ÅÁî®È¢òÂ∫ìÔºåÁªßÁª≠ÁôªÂΩï
                if app_file_logger:
                    try:
                        app_file_logger.warning(f"LoginWorker: tiku_init_failed -> {te}, disable tiku and continue")
                    except Exception:
                        pass
                try:
                    tiku.DISABLE = True
                except Exception:
                    pass

            chaoxing = Chaoxing(
                account=Account(self.username, self.password),
                tiku=tiku,
                http_proxy=getattr(self, "http_proxy", None),
            )
            state = chaoxing.login()
            if not state.get("status"):
                if app_file_logger:
                    try:
                        app_file_logger.warning(f"LoginWorker: login_failed -> {state}")
                    except Exception:
                        pass
                self.error.emit(state.get("msg", "ÁôªÂΩïÂ§±Ë¥•"))
                return
            courses = chaoxing.get_course_list()
            
            # È™åËØÅËØæÁ®ãÊï∞ÊçÆË¥®Èáè
            if courses:
                invalid_courses = []
                for course in courses:
                    if not (course.get('courseId') and course.get('clazzId') and course.get('cpi')):
                        invalid_courses.append(course.get('title', 'Unknown'))
                
                if invalid_courses:
                    if app_file_logger:
                        try:
                            app_file_logger.warning(f"LoginWorker: ÂèëÁé∞ {len(invalid_courses)} ‰∏™ËØæÁ®ãÊï∞ÊçÆ‰∏çÂÆåÊï¥: {invalid_courses}")
                        except Exception:
                            pass
                    
                    # Â¶ÇÊûúÊï∞ÊçÆË¥®ÈáèÂ§™Â∑ÆÔºåÂ∞ùËØïÂº∫Âà∂‰ΩøÁî®ÊóßÁâàAPI
                    if len(invalid_courses) > len(courses) * 0.5:  # Ë∂ÖËøá50%ËØæÁ®ãÊï∞ÊçÆ‰∏çÂÆåÊï¥
                        if app_file_logger:
                            try:
                                app_file_logger.info("LoginWorker: ËØæÁ®ãÊï∞ÊçÆË¥®ÈáèÂ∑ÆÔºåÂ∞ùËØïÂº∫Âà∂‰ΩøÁî®ÊóßÁâàAPI")
                            except Exception:
                                pass
                        courses = chaoxing.get_course_list(force_old_api=True)
            
            if app_file_logger:
                try:
                    app_file_logger.info(f"LoginWorker: courses_count={len(courses) if courses else 0}")
                except Exception:
                    pass
            self.success.emit(courses)
        except Exception as e:
            if app_file_logger:
                try:
                    app_file_logger.error(f"LoginWorker: exception -> {e}")
                except Exception:
                    pass
            self.error.emit(str(e))


class RunWorker(QThread):
    finished_ok = Signal()
    error = Signal(str)

    def __init__(
        self,
        username: str,
        password: str,
        courses: list,
        speed: float,
        notopen_action: str,
        tiku_conf: dict | None = None,
    ) -> None:
        super().__init__()
        self.username = username
        self.password = password
        self.courses = courses
        self.speed = max(1.0, min(2.0, float(speed)))
        self.notopen_action = notopen_action
        self.tiku_conf = tiku_conf or {}
        self._stop_requested = False

    def request_stop(self) -> None:
        self._stop_requested = True

    def run(self) -> None:
        try:
            from api.base import Chaoxing, Account
            from api.answer import Tiku
            from chaoxing.main import process_course

            # init tiku
            tiku = Tiku()
            try:
                if self.tiku_conf:
                    tiku.config_set(self.tiku_conf)
                tiku = tiku.get_tiku_from_config()
                tiku.init_tiku()
            except Exception as te:
                if app_file_logger:
                    try:
                        app_file_logger.warning(f"RunWorker: tiku_init_failed -> {te}, disable tiku and continue")
                    except Exception:
                        pass
                try:
                    tiku.DISABLE = True
                except Exception:
                    pass

            chaoxing = Chaoxing(
                account=Account(self.username, self.password),
                tiku=tiku,
                http_proxy=getattr(self, "http_proxy", None),
            )
            state = chaoxing.login()
            if not state.get("status"):
                self.error.emit(state.get("msg", "ÁôªÂΩïÂ§±Ë¥•"))
                return

            # Iterate selected courses
            for course in self.courses:
                if self._stop_requested:
                    break
                process_course(chaoxing, course, self.notopen_action, self.speed)

            if self._stop_requested:
                self.error.emit("Áî®Êà∑Â∑≤ÂÅúÊ≠¢")
            else:
                self.finished_ok.emit()

        except Exception as e:
            self.error.emit(str(e))


def run_gui() -> None:
    app = QApplication(sys.argv)
    win = MainWindow()
    win.show()
    sys.exit(app.exec())


if __name__ == "__main__":
    run_gui()
